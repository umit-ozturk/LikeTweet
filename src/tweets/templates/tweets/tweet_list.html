{% extends "base.html" %}

{% block script %}
<script>

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}


$(document).ready(function(){
	var query = getParameterByName("q");
	var tweetList = [];
	var nextTweetUrl;

	$(document.body).on("click", "retweetBtn", function(e){
		e.preventDefault()
		var url = "/api" + $(this).attr("href")
		$.ajax({
			method: "GET",
			url: url,
			success: function(data){
				attachTweet(data, true, true)
				updateHashLinks()

			},
			error: function(data){
				console.log("Error")
				console.log(data)
			}
		})
	})
	function updateHashLinks(){
		$(".media-body").each(function(data){
			var hashtagRegex = /(^|\s)#([\w\d-]+)/g
			var usernameRegex = /(^|\s)@([\w\d-]+)/g
			var currentHtml = $(this).html()
			var newText;
			newText = currentHtml.replace(hashtagRegex, "$1<a href='/tags/$2/'>#$2</a>")
			newText = newText.replace(usernameRegex, "$1 @<a href='/$2/'>$2</a>")

			$(this).html(newText)
		})
	}

	function attachTweet(tweetValue, prepend, retweet){
		var dateDisplay = tweetValue.date_display;
		var tweetContent = tweetValue.content;
		var tweetUser = tweetValue.user;
		var tweetFormattedHtml;
		if (retweet && tweetValue.parent){
			// Retweet
			var mainTweet = tweetValue.parent;
			tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\"> <span class='grey-color'>Retweet via " + tweetUser.username + " on " + dateDisplay + "</span><br/>" + mainTweet.content + "<br> via <a href='" + mainTweet.user.url + "'>" + mainTweet.user.username + "</a> | " + mainTweet.date_display + " | " + "<a href='/tweet/" + mainTweet.id + "'> View </a>| "+ "<a class='retweetBtn' href='/tweet/" + tweetValue.id + "/retweet/" + "'> Retweet </a>" + "</div></div><hr>";
		}else{
			// Tweet
			tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\">" + tweetContent + "<br> via <a href='" + tweetUser.url + "'>" + tweetUser.username + "</a> | " + dateDisplay + " | " + "<a href='/tweet/" + tweetValue.id + "'> View </a>| " + "<a class='retweetBtn' href='/tweet/" + tweetValue.id + "/retweet/" + "'> Retweet </a>" + "</div></div><hr>";
		}

		if(prepend == true){
			$("#tweet-container").prepend(tweetFormattedHtml)
		}else{
			$("#tweet-container").append(tweetFormattedHtml)
			
		}
	}

	function parseTweet(){
		if(tweetList == 0){
			$("#tweet-container").text("No Tweeet Found Currently");
		}else{
			$.each(tweetList, function(key, value){
				var tweetKey = key;
				if (value.parent){
					attachTweet(value, false, true)
				} else{
					attachTweet(value)
				}		
			})
		}
	}

	function fetchTweets(url){
		var fetchUrl;

		if (!url){
			fetchUrl = "/api/tweet/"
		}else{
			fetchUrl = url
		}

		$.ajax({
			url : fetchUrl,
			data : {
				"q" : query,
			},
			method : "GET",
			success: function(data){
				tweetList = data.results
				if(data.next){
					nextTweetUrl = data.next
				}else{
					$("#loadmore").hide()
				}
				parseTweet()
				updateHashLinks()
			},
			error: function(data){
				console.log(error)
			},
		})
	}

	fetchTweets()



	$("#loadmore").click(function(event){
		event.preventDefault();
		if(nextTweetUrl){
			fetchTweets(nextTweetUrl)
		}

	})

	var charsStart = 140;
	var charsCurrent = 0;


	$("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>")

	$("#tweet-form textarea").keyup(function(event){

		var tweetValue = $(this).val()
		charsCurrent = charsStart - tweetValue.length

		var spanChars = $("#tweetCharsLeft")
		spanChars.text(charsCurrent)

		if (charsCurrent > 0){
			spanChars.removeClass("grey-color")
			spanChars.removeClass("red-color")

		}else if ( charsCurrent == 0){
			spanChars.removeClass("red-color")
			spanChars.addClass("grey-color")

		}else {
			spanChars.removeClass("grey-color")
			spanChars.addClass("red-color")

		}

	})



	$("#tweet-form").submit(function(event){
		event.preventDefault()

		var this_ = $(this)
		var formData = this_.serialize()

		if (charsCurrent >= 0){
			$.ajax({
				url : "/api/tweet/create/",
				data : formData,
				method : "POST",
				success: function(data){
					this_.find("input[type=text], textarea").val("")
					attachTweet(data, true)
					updateHashLinks()
				},
				error: function(data){
					console.log(error)
				},
			})			
		}
		else{
			console.log("Cannot Send Tweet")
		}
	})
})

</script>


{% endblock script %}


{% block title %} LikeTweet | {{ block.super }} {% endblock title %}

{% block content %}



	<div class="row">
		<div class="col-sm-3 col-xs-12 pull-left" style="background-color:#F50057;">
			<h1>{{ request.user }}</h1>
		</div>
		<div class="col-sm-9">
			{% if not request.GET.q %}
				<div class="">
					{% include "tweets/form.html" with form=create_form action_url=create_url btn_title="Tweet" form_id="tweet-form" %}<br>
				</div><br>
				<hr/>
			{% endif %}
		<div id="tweet-container">

		</div>
		<a id="loadmore" href=""> Load More </a>

		</div>	
	</div>
{% endblock content %}


